# Filebeat Helm Values for DhakaCart
# This configures Filebeat for log collection from Kubernetes

# DaemonSet configuration
daemonset:
  enabled: true
  
  # Filebeat configuration
  filebeatConfig:
    filebeat.yml: |
      # Filebeat inputs
      filebeat.inputs:
      - type: container
        paths:
          - /var/log/containers/*dhakacart*.log
        processors:
        - add_kubernetes_metadata:
            host: ${NODE_NAME}
            matchers:
            - logs_path:
                logs_path: "/var/log/containers/"
        - decode_json_fields:
            fields: ["message"]
            target: ""
            overwrite_keys: true
        fields:
          log_type: application
        fields_under_root: true
      
      - type: container
        paths:
          - /var/log/containers/*nginx*.log
        processors:
        - add_kubernetes_metadata:
            host: ${NODE_NAME}
            matchers:
            - logs_path:
                logs_path: "/var/log/containers/"
        fields:
          log_type: nginx
        fields_under_root: true
      
      # Kubernetes system logs
      - type: container
        paths:
          - /var/log/containers/kube-*.log
          - /var/log/containers/coredns-*.log
        processors:
        - add_kubernetes_metadata:
            host: ${NODE_NAME}
            matchers:
            - logs_path:
                logs_path: "/var/log/containers/"
        fields:
          log_type: kubernetes
        fields_under_root: true
      
      # Node logs
      - type: log
        paths:
          - /var/log/syslog
          - /var/log/messages
        fields:
          log_type: system
        fields_under_root: true
      
      # Processors
      processors:
      - add_host_metadata:
          when.not.contains.tags: forwarded
      - add_cloud_metadata: ~
      - add_docker_metadata: ~
      - add_kubernetes_metadata: ~
      
      # Output to Logstash
      output.logstash:
        hosts: ["dhakacart-logstash:5044"]
        
      # Logging configuration
      logging.level: info
      logging.to_files: true
      logging.files:
        path: /usr/share/filebeat/logs
        name: filebeat
        keepfiles: 7
        permissions: 0644
      
      # Monitoring
      monitoring.enabled: true
      
      # Performance settings
      queue.mem:
        events: 4096
        flush.min_events: 512
        flush.timeout: 5s

  # Resource configuration
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

  # Security context
  securityContext:
    runAsUser: 0
    privileged: false

  # Volume mounts
  extraVolumes:
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlognginx
      hostPath:
        path: /var/log/nginx

  extraVolumeMounts:
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: varlognginx
      mountPath: /var/log/nginx
      readOnly: true

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations:
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

  # Affinity
  affinity: {}

  # Environment variables
  extraEnvs:
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName

# Deployment configuration (disabled in favor of DaemonSet)
deployment:
  enabled: false

# Service configuration
service:
  type: ClusterIP
  ports:
    - port: 5066
      targetPort: 5066
      protocol: TCP
      name: http

# ServiceMonitor for Prometheus
serviceMonitor:
  enabled: true
  labels:
    release: prometheus
  interval: 30s
  scrapeTimeout: 10s

# Image configuration
image: "docker.elastic.co/beats/filebeat"
imageTag: "8.11.0"
imagePullPolicy: "IfNotPresent"

# Pod annotations
podAnnotations: {}

# Labels
labels: {}

# Priority class
priorityClassName: ""

# Update strategy
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1

# Lifecycle hooks
lifecycle: {}

# Liveness probe
livenessProbe:
  exec:
    command:
      - sh
      - -c
      - |
        #!/usr/bin/env bash -e
        curl --fail 127.0.0.1:5066
  failureThreshold: 3
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5

# Readiness probe
readinessProbe:
  exec:
    command:
      - sh
      - -c
      - |
        #!/usr/bin/env bash -e
        filebeat test output
  failureThreshold: 3
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5

# Manage the template
managedServiceAccount: true

# Cluster role binding
clusterRoleRules:
  - apiGroups: [""]
    resources:
      - nodes
      - namespaces
      - events
      - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions"]
    resources:
      - replicasets
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources:
      - statefulsets
      - deployments
      - replicasets
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources:
      - nodes/stats
    verbs: ["get"]